<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buoy Dashboard - Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0a0a; --bg-secondary: #111111; --bg-tertiary: #1a1a1a;
            --border: #2a2a2a; --border-hover: #3a3a3a;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-muted: #666666;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --accent: #0ea5e9; --override: #f97316; --purple: #a855f7;
        }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-primary);
            color: var(--text-primary); min-height: 100vh; line-height: 1.6;
        }
        .status-banner {
            position: fixed; top: 0; left: 0; right: 0; padding: 16px 30px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 5000; font-weight: 600; border-bottom: 2px solid;
            backdrop-filter: blur(10px); animation: slideDown 0.4s ease;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .banner-not-deployed { background: rgba(168, 85, 247, 0.15); border-color: var(--purple); color: var(--purple); }
        .banner-override { background: rgba(249, 115, 22, 0.15); border-color: var(--override); color: var(--override); animation: pulse-banner 2s infinite; }
        .banner-impact { background: rgba(239, 68, 68, 0.15); border-color: var(--danger); color: var(--danger); animation: pulse-banner 1s infinite; }
        .banner-drift { background: rgba(245, 158, 11, 0.15); border-color: var(--warning); color: var(--warning); }
        @keyframes pulse-banner { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .banner-content { display: flex; align-items: center; gap: 15px; font-size: 0.95em; }
        .banner-icon { font-size: 1.4em; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .banner-text { display: flex; flex-direction: column; gap: 2px; }
        .banner-title { font-size: 1.1em; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .banner-subtitle { font-size: 0.85em; opacity: 0.8; }
        .banner-action {
            padding: 8px 16px; background: rgba(255, 255, 255, 0.1);
            border: 1px solid currentColor; border-radius: 6px;
            color: inherit; font-weight: 600; cursor: pointer;
            transition: all 0.2s; text-transform: uppercase;
            font-size: 0.8em; letter-spacing: 0.5px;
        }
        .banner-action:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.05); }
        .container { max-width: 1600px; margin: 0 auto; padding: 40px 30px; position: relative; z-index: 1; }
        .container.has-banner { padding-top: 100px; }
        .controls { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .control-btn {
            width: 50px; height: 50px; background: var(--bg-secondary);
            border: 1px solid var(--border); border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; font-size: 1.2em;
        }
        .control-btn:hover { background: var(--bg-tertiary); border-color: var(--border-hover); transform: scale(1.05); }
        .control-btn.active { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .control-btn.maintenance-btn {
            width: auto; padding: 0 16px; gap: 8px; font-size: 0.85em;
            font-weight: 600; background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger); color: var(--danger);
        }
        .header { margin-bottom: 40px; padding-bottom: 30px; border-bottom: 1px solid var(--border); }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .header-title h1 {
            font-size: 2.2em; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header-subtitle { font-size: 0.9em; color: var(--text-secondary); }
        .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .status-box {
            display: flex; align-items: center; gap: 10px; padding: 10px 18px;
            background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--text-muted); transition: all 0.3s;
        }
        .status-dot.active { background: var(--success); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); animation: pulse 2s infinite; }
        .status-dot.override { background: var(--override); box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); animation: pulse-orange 1s infinite; }
        .status-dot.not-deployed { background: var(--purple); box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2); animation: pulse-purple 2s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); } 50% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } }
        @keyframes pulse-orange { 0%, 100% { box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); } 50% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); } }
        @keyframes pulse-purple { 0%, 100% { box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2); } 50% { box-shadow: 0 0 0 6px rgba(168, 85, 247, 0); } }
        .status-text { font-size: 0.85em; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .live-clock { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; padding: 10px 18px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; }
        .header-meta { display: flex; gap: 30px; font-size: 0.85em; color: var(--text-muted); }
        .meta-item { display: flex; gap: 8px; }
        .meta-value { font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); }
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
        .chart-section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 25px; transition: border-color 0.3s; }
        .chart-title { font-size: 0.75em; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 15px; }
        .chart-section canvas { max-height: 200px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 28px; transition: all 0.2s; }
        .stat-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
        .stat-label { font-size: 0.75em; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; }
        .stat-value { font-size: 2.5em; font-weight: 700; letter-spacing: -1px; font-family: 'JetBrains Mono', monospace; margin-bottom: 8px; }
        .stat-value.highlight { color: var(--accent); }
        .stat-unit { font-size: 0.85em; color: var(--text-secondary); }
        .status-panel { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 30px; }
        .panel-title { font-size: 0.75em; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; }
        .status-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border); }
        .status-item:last-child { border-bottom: none; }
        .status-label { font-size: 0.9em; color: var(--text-secondary); }
        .badge {
            padding: 5px 12px; border-radius: 6px; font-size: 0.7em;
            font-weight: 700; text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
            display: inline-block; margin-left: 5px;
        }
        .badge.success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge.override { background: rgba(249, 115, 22, 0.1); color: var(--override); border: 1px solid rgba(249, 115, 22, 0.2); }
        .badge.purple { background: rgba(168, 85, 247, 0.1); color: var(--purple); border: 1px solid rgba(168, 85, 247, 0.2); }
        .badge.neutral { background: rgba(255, 255, 255, 0.05); color: var(--text-secondary); border: 1px solid var(--border); }
        .timeline-section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 30px; margin-bottom: 25px; }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .timeline-clear { padding: 6px 14px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 0.7em; font-weight: 600; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .timeline { position: relative; padding-left: 25px; }
        .timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--border); }
        .timeline-item { position: relative; padding: 16px 0; border-bottom: 1px solid var(--border); }
        .timeline-item::before { content: ''; position: absolute; left: -30px; top: 22px; width: 10px; height: 10px; border-radius: 50%; background: var(--accent); border: 2px solid var(--bg-secondary); }
        .timeline-content { display: flex; justify-content: space-between; }
        .timeline-type { font-weight: 600; margin-bottom: 4px; }
        .timeline-details { font-size: 0.85em; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }
        .timeline-time { font-size: 0.75em; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .timeline-empty { text-align: center; padding: 30px; color: var(--text-muted); }
        .data-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .data-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; transition: all 0.2s; }
        .data-label { font-size: 0.75em; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
        .data-value { font-size: 1.8em; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .data-subtext { font-size: 0.8em; color: var(--text-secondary); margin-top: 6px; }
        .location-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .location-label { font-size: 0.7em; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
        .location-value { font-size: 1.6em; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .notifications { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; max-width: 350px; }
        .notification { background: var(--bg-secondary); border: 1px solid var(--border-hover); border-radius: 8px; padding: 14px 18px; display: flex; gap: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        .notification-icon { width: 6px; height: 6px; border-radius: 50%; margin-top: 6px; }
        .notification.success .notification-icon { background: var(--success); }
        .notification.warning .notification-icon { background: var(--warning); }
        .notification.danger .notification-icon { background: var(--danger); }
        .notification.info .notification-icon { background: var(--accent); }
        .notification.purple .notification-icon { background: var(--purple); }
        .notification-title { font-size: 0.85em; font-weight: 600; margin-bottom: 3px; }
        .notification-message { font-size: 0.75em; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }
        .notification-close { margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2em; }
        .loading { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 10000; transition: opacity 0.3s; }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .value-changed { animation: highlight 0.4s ease; }
        @keyframes highlight { 50% { background: rgba(14, 165, 233, 0.1); transform: scale(1.02); } }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); z-index: 9000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; }
        .modal-title { font-size: 1.4em; font-weight: 700; margin-bottom: 10px; }
        .modal-text { color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6; }
        .modal-buttons { display: flex; gap: 12px; justify-content: flex-end; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border); background: transparent; color: var(--text-primary); }
        .modal-btn.primary { background: var(--danger); border-color: var(--danger); color: white; }
        .footer { margin-top: 40px; padding-top: 25px; border-top: 1px solid var(--border); text-align: center; font-size: 0.8em; color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="spinner"></div></div>
    <div id="statusBanner"></div>
    <div class="modal" id="maintenanceModal">
        <div class="modal-content">
            <div class="modal-title">Send Maintenance Command</div>
            <div class="modal-text">This will clear the current alert state (IMPACT or DRIFT). The buoy will return to normal monitoring mode.<br><br><strong>Are you sure?</strong></div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeMaintenanceModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmMaintenance()">Send Command</button>
            </div>
        </div>
    </div>
    <div class="notifications" id="notifications"></div>
    <div class="controls">
        <div class="control-btn maintenance-btn" id="maintenanceBtn" title="Send Maintenance" style="display: none;"><span>üîß</span><span>MAINTENANCE</span></div>
        <div class="control-btn" id="soundBtn" title="Toggle Sound">üîá</div>
        <div class="control-btn" id="exportBtn" title="Export Data">‚¨á</div>
        <div class="control-btn" id="fullscreenBtn" title="Fullscreen">‚õ∂</div>
    </div>
    <div class="container" id="mainContainer">
        <header class="header">
            <div class="header-top">
                <div class="header-title">
                    <h1>ESP32 Buoy Monitor</h1>
                    <div class="header-subtitle">Real-time ocean monitoring system</div>
                </div>
                <div class="header-right">
                    <div class="status-box"><div class="status-dot" id="statusDot"></div><span class="status-text" id="statusText">CONNECTING</span></div>
                    <div class="live-clock" id="clock">--:--:--</div>
                </div>
            </div>
            <div class="header-meta">
                <div class="meta-item"><span>Channel:</span><span class="meta-value">3203006</span></div>
                <div class="meta-item"><span>Last Update:</span><span class="meta-value" id="lastUpdate">--:--:--</span></div>
                <div class="meta-item"><span>Refresh:</span><span class="meta-value">20s</span></div>
            </div>
        </header>
        <div class="main-grid">
            <div class="chart-section"><div class="chart-title">Magnitude Trend (Last 15 readings)</div><canvas id="chart"></canvas></div>
            <div class="status-panel">
                <div class="panel-title">System Status</div>
                <div class="status-item"><span class="status-label">Deployment</span><span id="deployStatus"><span class="badge neutral">UNKNOWN</span></span></div>
                <div class="status-item"><span class="status-label">Mode</span><span id="modeStatus"><span class="badge neutral">NORMAL</span></span></div>
                <div class="status-item"><span class="status-label">GPS Lock</span><span id="gpsStatus"><span class="badge neutral">CHECKING</span></span></div>
                <div class="status-item"><span class="status-label">Connection</span><span><span class="badge success">STABLE</span></span></div>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Event Counter</div><div class="stat-value" id="eventCount">--</div><div class="stat-unit">Total events</div></div>
            <div class="stat-card"><div class="stat-label">Signal Strength</div><div class="stat-value" id="rssi">--</div><div class="stat-unit">dBm (RSSI)</div></div>
            <div class="stat-card"><div class="stat-label">Magnitude</div><div class="stat-value highlight" id="magnitude">--</div><div class="stat-unit">Current reading</div></div>
            <div class="stat-card"><div class="stat-label">Total Packets</div><div class="stat-value highlight" id="totalPackets">--</div><div class="stat-unit">Received</div></div>
        </div>
        <div class="timeline-section">
            <div class="timeline-header"><div class="chart-title">Event Timeline</div><button class="timeline-clear" id="clearBtn">Clear</button></div>
            <div class="timeline" id="timeline"><div class="timeline-empty">No events recorded</div></div>
        </div>
        <div class="data-grid">
            <div class="data-card"><div class="data-label">Last Event Type</div><div class="data-value" id="lastEventType">--</div><div class="data-subtext" id="eventTypeSub">Event classification</div></div>
            <div class="data-card"><div class="data-label">GPS Status</div><div class="data-value" id="gpsValid">--</div><div class="data-subtext">Position lock</div></div>
            <div class="data-card"><div class="data-label">Network</div><div class="data-value">ACTIVE</div><div class="data-subtext">Connection stable</div></div>
        </div>
        <div class="location-card">
            <div><div class="location-label">Latitude</div><div class="location-value" id="lat">--¬∞</div></div>
            <div><div class="location-label">Longitude</div><div class="location-value" id="lon">--¬∞</div></div>
        </div>
        <footer class="footer"><div><strong>Muhammad Irfan</strong> ¬∑ <a href="https://instagram.com/hzetronics" target="_blank">@Hzetronics</a></div><div>Powered by ThingSpeak API</div></footer>
    </div>
    <script>
        const CHANNEL_ID = "3203006", READ_API_KEY = "JN2TR7S7XJLS9TWW", WRITE_API_KEY = "YL2NG29Y3OFC2O9B", REFRESH_MS = 20000;
        let chart, prevData = {}, timeline = [], soundOn = false, firstLoad = true, magnitudeHistory = [];
        let currentDeployed = null, currentOverride = null, currentEventType = null;
        
        const EVENT_TYPES = { 0: 'OFFLINE', 1: 'STATUS', 2: 'DRIFT', 3: 'IMPACT' };
        
        chart = new Chart(document.getElementById('chart'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#2a2a2a' }, ticks: { color: '#666' } }, y: { grid: { color: '#2a2a2a' }, ticks: { color: '#666' } } } }
        });
        
        setInterval(() => { document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour12: false }); }, 1000);
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(freq = 800, dur = 80) {
            if (!soundOn) return;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur/1000);
            osc.start(); osc.stop(audioCtx.currentTime + dur/1000);
        }
        
        document.getElementById('soundBtn').onclick = function() {
            soundOn = !soundOn; this.classList.toggle('active'); this.textContent = soundOn ? 'üîä' : 'üîá';
            if (soundOn) beep(600);
        };
        
        document.getElementById('exportBtn').onclick = function() {
            const data = { timestamp: new Date().toISOString(), current: prevData, timeline };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `buoy-${Date.now()}.json`; a.click();
            URL.revokeObjectURL(url); notify('Data Exported', 'File saved successfully', 'success');
        };
        
        document.getElementById('fullscreenBtn').onclick = function() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        };
        
        document.getElementById('clearBtn').onclick = function() {
            timeline = []; renderTimeline(); notify('Timeline Cleared', 'All events removed', 'info');
        };
        
        document.getElementById('maintenanceBtn').onclick = function() {
            document.getElementById('maintenanceModal').classList.add('show');
        };
        
        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.remove('show');
        }
        
        async function confirmMaintenance() {
            closeMaintenanceModal();
            try {
                const res = await fetch(`https://api.thingspeak.com/update?api_key=${WRITE_API_KEY}&field9=1`);
                if (res.ok) {
                    notify('Maintenance Sent', 'Command sent to buoy', 'success');
                    setTimeout(fetchData, 2000);
                } else {
                    notify('Error', 'Failed to send command', 'danger');
                }
            } catch (e) {
                notify('Error', 'Network error: ' + e.message, 'danger');
            }
        }
        
        function updateBanner(online, deployed, override, eventType) {
            const banner = document.getElementById('statusBanner');
            const container = document.getElementById('mainContainer');
            let html = '';
            
            // Priority order: Override > Not Deployed > Event Alerts > Offline
            if (override === '1') {
                html = `<div class="status-banner banner-override">
                    <div class="banner-content">
                        <div class="banner-icon">üîß</div>
                        <div class="banner-text">
                            <div class="banner-title">Override Mode Active</div>
                            <div class="banner-subtitle">Manual control enabled - System thresholds bypassed</div>
                        </div>
                    </div>
                </div>`;
                container.classList.add('has-banner');
            } else if (deployed === '0') {
                html = `<div class="status-banner banner-not-deployed">
                    <div class="banner-content">
                        <div class="banner-icon">‚ö†Ô∏è</div>
                        <div class="banner-text">
                            <div class="banner-title">System Not Deployed</div>
                            <div class="banner-subtitle">Buoy is in free/test mode - Deploy to activate monitoring</div>
                        </div>
                    </div>
                </div>`;
                container.classList.add('has-banner');
            } else if (eventType === 'IMPACT') {
                html = `<div class="status-banner banner-impact">
                    <div class="banner-content">
                        <div class="banner-icon">üí•</div>
                        <div class="banner-text">
                            <div class="banner-title">Impact Alert Active</div>
                            <div class="banner-subtitle">High energy detection - Immediate attention required</div>
                        </div>
                    </div>
                    <button class="banner-action" onclick="document.getElementById('maintenanceBtn').click()">Clear Alert</button>
                </div>`;
                container.classList.add('has-banner');
            } else if (eventType === 'DRIFT') {
                html = `<div class="status-banner banner-drift">
                    <div class="banner-content">
                        <div class="banner-icon">üåä</div>
                        <div class="banner-text">
                            <div class="banner-title">Drift Alert Active</div>
                            <div class="banner-subtitle">Position drift detected - Monitor closely</div>
                        </div>
                    </div>
                    <button class="banner-action" onclick="document.getElementById('maintenanceBtn').click()">Clear Alert</button>
                </div>`;
                container.classList.add('has-banner');
            } else if (online === '0') {
                html = `<div class="status-banner banner-impact">
                    <div class="banner-content">
                        <div class="banner-icon">üì°</div>
                        <div class="banner-text">
                            <div class="banner-title">Buoy Offline</div>
                            <div class="banner-subtitle">No signal received - Connection lost</div>
                        </div>
                    </div>
                </div>`;
                container.classList.add('has-banner');
            } else {
                container.classList.remove('has-banner');
            }
            
            banner.innerHTML = html;
            
            const maintenanceBtn = document.getElementById('maintenanceBtn');
            if (eventType === 'IMPACT' || eventType === 'DRIFT') {
                maintenanceBtn.style.display = 'flex';
            } else {
                maintenanceBtn.style.display = 'none';
            }
        }
        
        function notify(title, msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.innerHTML = `
                <div class="notification-icon"></div>
                <div>
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${msg}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.getElementById('notifications').appendChild(div);
            beep(type === 'success' ? 1000 : type === 'warning' ? 600 : 800);
            setTimeout(() => { div.classList.add('hiding'); setTimeout(() => div.remove(), 300); }, 4000);
        }
        
        function highlight(id) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('value-changed');
                void el.offsetWidth;
                el.classList.add('value-changed');
                setTimeout(() => el.classList.remove('value-changed'), 400);
            }
        }
        
        function renderTimeline() {
            const div = document.getElementById('timeline');
            if (timeline.length === 0) {
                div.innerHTML = '<div class="timeline-empty">No events recorded</div>';
                return;
            }
            div.innerHTML = timeline.map(e => `
                <div class="timeline-item">
                    <div class="timeline-content">
                        <div>
                            <div class="timeline-type">${e.type}</div>
                            <div class="timeline-details">Magnitude: ${e.mag}</div>
                        </div>
                        <div class="timeline-time">${new Date(e.time).toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function checkChanges(data) {
            if (!Object.keys(prevData).length) {
                prevData = {...data};
                return;
            }
            
            if (data.eventType !== prevData.eventType) {
                let notifyType = 'info';
                if (data.eventType === 'IMPACT') notifyType = 'danger';
                else if (data.eventType === 'DRIFT') notifyType = 'warning';
                else if (data.eventType === 'OFFLINE') notifyType = 'danger';
                
                if (data.eventType !== 'STATUS' && data.eventType !== 'OFFLINE') {
                    notify('New Event', `Type: ${data.eventType}`, notifyType);
                    highlight('lastEventType');
                    
                    timeline.unshift({ type: data.eventType, mag: data.magnitude, time: Date.now() });
                    if (timeline.length > 10) timeline.pop();
                    renderTimeline();
                }
            }
            
            if (parseInt(data.eventCounter) > parseInt(prevData.eventCounter || 0)) {
                notify('Event Counter', `Total: ${data.eventCounter}`, 'info');
                highlight('eventCount');
            }
            
            if (parseInt(data.totalPackets) > parseInt(prevData.totalPackets || 0)) {
                highlight('totalPackets');
            }
            
            if (data.gpsValid !== prevData.gpsValid) {
                if (data.gpsValid === '1') {
                    notify('GPS Status', 'Lock acquired', 'success');
                } else {
                    notify('GPS Status', 'Lock lost', 'danger');
                }
                highlight('gpsStatus');
            }
            
            if (data.magnitude !== prevData.magnitude) {
                highlight('magnitude');
            }
            
            if (data.online !== prevData.online) {
                if (data.online === '1') {
                    notify('Buoy Online', 'Connection established', 'success');
                } else {
                    notify('Buoy Offline', 'Connection lost', 'danger');
                }
            }
            
            if (data.deployed !== prevData.deployed) {
                if (data.deployed === '1') {
                    notify('Deployment', 'Buoy deployed and active', 'success');
                } else {
                    notify('Deployment', 'Buoy in free mode', 'purple');
                }
            }
            
            if (data.override !== prevData.override) {
                if (data.override === '1') {
                    notify('Override Mode', 'Manual control enabled', 'warning');
                } else {
                    notify('Normal Mode', 'Automatic monitoring resumed', 'success');
                }
            }
            
            prevData = {...data};
        }
        
        async function fetchData() {
            try {
                const res = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json?api_key=${READ_API_KEY}`);
                const data = await res.json();
                
                if (firstLoad) {
                    setTimeout(() => {
                        document.getElementById('loading').classList.add('hidden');
                        notify('Connected', 'Dashboard online', 'success');
                    }, 1000);
                    firstLoad = false;
                }
                
                const eventTypeCode = parseInt(data.field1) || 0;
                const eventType = EVENT_TYPES[eventTypeCode] || 'UNKNOWN';
                
                const parsed = {
                    online: data.field1 || '0',
                    eventType: eventType,
                    magnitude: data.field3 || '--',
                    rssi: data.field4 || '--',
                    gpsValid: data.field5,
                    lat: data.field6,
                    lon: data.field7,
                    totalPackets: data.field8 || '0',
                    eventCounter: '0',
                    deployed: data.field10 || '0',
                    override: data.field11 || '0'
                };
                
                const dot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (parsed.online === '0') {
                    dot.className = 'status-dot';
                    statusText.textContent = 'OFFLINE';
                } else if (parsed.deployed === '0') {
                    dot.className = 'status-dot not-deployed';
                    statusText.textContent = 'NOT DEPLOYED';
                } else if (parsed.override === '1') {
                    dot.className = 'status-dot override';
                    statusText.textContent = 'OVERRIDE MODE';
                } else {
                    dot.className = 'status-dot active';
                    statusText.textContent = 'CONNECTED';
                }
                
                updateBanner(parsed.online, parsed.deployed, parsed.override, parsed.eventType);
                checkChanges(parsed);
                
                if (parsed.magnitude !== '--') {
                    const mag = parseFloat(parsed.magnitude);
                    if (!isNaN(mag)) {
                        magnitudeHistory.push(mag);
                        if (magnitudeHistory.length > 15) magnitudeHistory.shift();
                        chart.data.labels = magnitudeHistory.map((_, i) => i + 1);
                        chart.data.datasets[0].data = magnitudeHistory;
                        chart.update('none');
                    }
                }
                
                document.getElementById('eventCount').textContent = parsed.eventCounter;
                document.getElementById('rssi').textContent = parsed.rssi;
                document.getElementById('magnitude').textContent = parsed.magnitude;
                document.getElementById('totalPackets').textContent = parsed.totalPackets;
                
                const eventEl = document.getElementById('lastEventType');
                eventEl.textContent = parsed.eventType;
                
                if (parsed.eventType === 'IMPACT') {
                    eventEl.style.color = 'var(--danger)';
                    document.getElementById('eventTypeSub').textContent = 'High energy detection';
                } else if (parsed.eventType === 'DRIFT') {
                    eventEl.style.color = 'var(--warning)';
                    document.getElementById('eventTypeSub').textContent = 'Position drift detected';
                } else if (parsed.eventType === 'STATUS') {
                    eventEl.style.color = 'var(--accent)';
                    document.getElementById('eventTypeSub').textContent = 'Status update';
                } else if (parsed.eventType === 'OFFLINE') {
                    eventEl.style.color = 'var(--danger)';
                    document.getElementById('eventTypeSub').textContent = 'Connection lost';
                } else {
                    eventEl.style.color = 'var(--text-primary)';
                    document.getElementById('eventTypeSub').textContent = 'Event classification';
                }
                
                document.getElementById('gpsValid').textContent = parsed.gpsValid === '1' ? 'VALID' : 'INVALID';
                document.getElementById('lat').textContent = parsed.lat ? parseFloat(parsed.lat).toFixed(6) + '¬∞' : 'NO DATA';
                document.getElementById('lon').textContent = parsed.lon ? parseFloat(parsed.lon).toFixed(6) + '¬∞' : 'NO DATA';
                
                const deployEl = document.getElementById('deployStatus');
                if (parsed.deployed === '1') {
                    deployEl.innerHTML = '<span class="badge success">DEPLOYED</span>';
                } else {
                    deployEl.innerHTML = '<span class="badge purple">FREE MODE</span>';
                }
                
                const modeEl = document.getElementById('modeStatus');
                if (parsed.override === '1') {
                    modeEl.innerHTML = '<span class="badge override">OVERRIDE</span>';
                } else {
                    modeEl.innerHTML = '<span class="badge success">NORMAL</span>';
                }
                
                const gpsEl = document.getElementById('gpsStatus');
                if (parsed.gpsValid === '1') {
                    gpsEl.innerHTML = '<span class="badge success">LOCKED</span>';
                } else {
                    gpsEl.innerHTML = '<span class="badge danger">NO LOCK</span>';
                }
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
                
            } catch (e) {
                console.error(e);
                document.getElementById('statusDot').className = 'status-dot';
                document.getElementById('statusText').textContent = 'ERROR';
                if (!firstLoad) notify('Connection Error', 'Failed to fetch data', 'warning');
            }
        }
        
        fetchData();
        setInterval(fetchData, REFRESH_MS);
    </script>
</body>
</html>
