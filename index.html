<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ESP32 Buoy Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
/* --- Styles from your modern dashboard --- */
* { margin:0;padding:0;box-sizing:border-box; }
body { font-family: 'Montserrat', sans-serif; background:#000; color:#fff; min-height:100vh; padding:40px 20px; line-height:1.6; }
.container { max-width:1600px; margin:0 auto; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:60px; padding-bottom:30px; border-bottom:1px solid #222; }
.header-title { display:flex; align-items:baseline; gap:16px; }
.header h1 { font-size:2em; font-weight:700; text-transform:uppercase; letter-spacing:-1px; }
.header-credit { font-size:0.75em; font-weight:500; color:#666; text-transform:lowercase; letter-spacing:1px; }
.status-indicator { display:flex; align-items:center; gap:12px; font-size:0.8em; font-weight:600; text-transform:uppercase; letter-spacing:1px; }
.status-dot { width:10px;height:10px;border-radius:50%;background:#444;position:relative; }
.status-dot.connected { background:#0ff; box-shadow:0 0 10px #0ff; }
.dashboard { transition:all 0.5s ease; opacity:0; transform:translateY(20px); }
.dashboard.visible { opacity:1; transform:translateY(0); }
.gps-status-banner { background:#0a0a0a; border:1px solid #333; border-left:4px solid #ffcc00; padding:24px; margin-bottom:40px; display:none; align-items:center; gap:20px; animation:slideDown 0.5s ease; }
.gps-status-banner.active { display:flex; }
.gps-status-banner.monitoring { border-left-color:#0ff; }
@keyframes slideDown { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
.card { background:#0a0a0a; border:1px solid #222; border-radius:0; padding:32px; transition:all 0.3s ease; position:relative; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr)); gap:24px; margin-bottom:40px; }
.card-header { margin-bottom:32px; padding-bottom:20px; border-bottom:1px solid #1a1a1a; }
.card-title { font-size:0.75em; font-weight:700; color:#fff; letter-spacing:2px; text-transform:uppercase; }
.data-grid { display:grid; gap:24px; }
.data-item { display:flex; justify-content:space-between; align-items:baseline; gap:16px; }
.data-label { font-size:0.75em; color:#666; font-weight:600; text-transform:uppercase; letter-spacing:1.5px; }
.data-value { font-size:1.25em; font-weight:600; color:#fff; font-variant-numeric:tabular-nums; letter-spacing:-0.5px; }
.data-value.invalid { color:#333; font-style:italic; font-weight:400; }
.data-value.drift-warning { color:#ffcc00; }
.data-value.drift-danger { color:#ff3333; }
.section-title { font-size:0.75em; font-weight:700; color:#666; letter-spacing:2px; text-transform:uppercase; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; }
.clear-events-btn { background:transparent; color:#666; border:1px solid #333; padding:8px 20px; font-size:0.75em; transition:all 0.3s ease; }
.clear-events-btn:hover:not(:disabled) { background:#ff3333; color:#fff; border-color:#ff3333; }
.event-list { display:grid; gap:16px; }
.event-item { background:#0a0a0a; border:1px solid #222; padding:24px; transition:all 0.3s ease; animation:slideIn 0.5s ease; }
@keyframes slideIn { from {opacity:0; transform:translateX(-20px);} to {opacity:1; transform:translateX(0);} }
.event-item.impact { border-left:3px solid #0ff; }
.event-item.drift { border-left:3px solid #ffcc00; }
.event-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.event-type { font-size:0.85em; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; }
.event-time { font-size:0.75em; color:#666; font-family:'Courier New',monospace; }
.event-detail { color:#888; }
.event-detail strong { color:#fff; }
.empty-state { text-align:center; padding:60px 20px; color:#444; }
.empty-state-text { font-size:0.85em; text-transform:uppercase; letter-spacing:1px; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-title">
            <h1>ESP32 BUOY MONITOR</h1>
            <span class="header-credit">by Irfan</span>
        </div>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">DISCONNECTED</span>
        </div>
    </div>

    <div class="dashboard visible">
        <!-- GPS Status Banner -->
        <div class="gps-status-banner" id="gpsStatusBanner">
            <div class="gps-status-content">
                <div class="gps-status-title" id="gpsStatusTitle">GPS STATUS</div>
                <div class="gps-status-message" id="gpsStatusMessage">Initializing...</div>
            </div>
        </div>

        <div class="section-title">Live Sensor Data</div>
        <div class="grid">
            <div class="card">
                <div class="card-header"><div class="card-title">Sensor Data</div></div>
                <div class="data-grid">
                    <div class="data-item"><span class="data-label">Event Type</span><span class="data-value" id="eventType">--</span></div>
                    <div class="data-item"><span class="data-label">Magnitude</span><span class="data-value" id="magnitude">--</span></div>
                    <div class="data-item"><span class="data-label">RSSI</span><span class="data-value" id="rssi">-- dBm</span></div>
                    <div class="data-item"><span class="data-label">Latitude</span><span class="data-value" id="lat">--</span></div>
                    <div class="data-item"><span class="data-label">Longitude</span><span class="data-value" id="lon">--</span></div>
                    <div class="data-item"><span class="data-label">Event Counter</span><span class="data-value" id="count">--</span></div>
                    <div class="data-item"><span class="data-label">Status</span><span class="data-value" id="statusVal">--</span></div>
                </div>
            </div>
        </div>

        <div class="section-title">
            <span>Event History (Impact & Drift Detection)</span>
            <button class="btn clear-events-btn" onclick="clearEvents()">CLEAR EVENTS</button>
        </div>
        <div class="event-list" id="eventList">
            <div class="empty-state"><div class="empty-state-text">No events detected yet</div></div>
        </div>
    </div>
</div>

<script>
const CHANNEL_ID = "3203006";
const READ_API_KEY = "JN2TR7S7XJLS9TWW";
const REFRESH_MS = 5000;

let events = [];

async function fetchData() {
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json?api_key=${READ_API_KEY}`;
    try {
        const res = await fetch(url);
        const data = await res.json();

        const eventType = data.field1 || '--';
        const magnitude = data.field2 || 0;
        const lat = data.field3 || '--';
        const lon = data.field4 || '--';
        const rssi = data.field5 || '--';
        const count = data.field7 || 0;
        const status = data.field8 || 'DISCONNECTED';

        document.getElementById('eventType').textContent = eventType;
        document.getElementById('magnitude').textContent = magnitude;
        document.getElementById('lat').textContent = lat;
        document.getElementById('lon').textContent = lon;
        document.getElementById('rssi').textContent = rssi + ' dBm';
        document.getElementById('count').textContent = count;
        document.getElementById('statusVal').textContent = status;

        // GPS banner
        const gpsBanner = document.getElementById('gpsStatusBanner');
        const gpsTitle = document.getElementById('gpsStatusTitle');
        const gpsMsg = document.getElementById('gpsStatusMessage');
        if(status.includes('GPS_FAILED')){
            gpsBanner.classList.add('active');
            gpsBanner.classList.remove('monitoring');
            gpsTitle.textContent = 'GPS FAILED';
            gpsMsg.textContent = 'Initializing...';
        } else {
            gpsBanner.classList.add('active','monitoring');
            gpsTitle.textContent = 'GPS ACTIVE';
            gpsMsg.textContent = 'Tracking position';
        }

        // Status dot
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        statusText.textContent = status;
        if(status === 'DEPLOYED' || status === 'ONLINE'){
            statusDot.classList.add('connected');
        } else {
            statusDot.classList.remove('connected');
        }

        // Add event to history if new
        if(eventType && eventType!=='--'){
            const now = new Date().toLocaleString();
            addEvent({eventType, magnitude, latitude: lat, longitude: lon, dateTime: now, locationValid: lat!=='--'});
        }

    } catch(e){
        console.error('ThingSpeak fetch error', e);
    }
}

function addEvent(event){
    events.unshift(event);
    if(events.length>10) events.pop();
    renderEvents();
}

function renderEvents(){
    const eventList = document.getElementById('eventList');
    if(events.length===0){
        eventList.innerHTML = '<div class="empty-state"><div class="empty-state-text">No events detected yet</div></div>';
        return;
    }
    let html = '';
    events.forEach(ev=>{
        const loc = ev.locationValid ? ev.latitude + '°, ' + ev.longitude + '°' : 'No GPS fix';
        const cls = ev.eventType.toLowerCase() === 'drift' ? 'drift' : 'impact';
        const unit = ev.eventType.toLowerCase() === 'drift' ? 'm' : 'm/s²';
        html += `<div class="event-item ${cls}">
            <div class="event-header">
                <div class="event-type">${ev.eventType}</div>
                <div class="event-time">${ev.dateTime}</div>
            </div>
            <div class="event-details">
                <div class="event-detail"><strong>Magnitude:</strong> ${ev.magnitude} ${unit}</div>
                <div class="event-detail"><strong>Location:</strong> ${loc}</div>
            </div>
        </div>`;
    });
    eventList.innerHTML = html;
}

function clearEvents(){
    events=[];
    renderEvents();
}

fetchData();
setInterval(fetchData, REFRESH_MS);
</script>
</body>
</html>
