<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ocean Buoy Dashboard</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #0a1e2f;
    color: #f0f0f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 0;
  }
  h1 {
    margin-top: 20px;
    font-size: 1.8rem;
    color: #00d4ff;
  }
  .status-box {
    background-color: #112b3c;
    border-radius: 10px;
    padding: 20px;
    margin: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.4);
  }
  .status {
    font-size: 1.2rem;
    margin: 10px 0;
  }
  .event-warning {
    font-weight: bold;
    color: #ff4d4d;
    font-size: 1.3rem;
    animation: blink 1s infinite;
  }
  @keyframes blink {
    0%,50%,100% { opacity: 1; }
    25%,75% { opacity: 0.2; }
  }
  button {
    background-color: #00d4ff;
    color: #0a1e2f;
    border: none;
    padding: 10px 15px;
    margin-top: 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
  }
  button:hover {
    background-color: #00b0cc;
  }
  .data-row {
    display: flex;
    justify-content: space-between;
    margin: 5px 0;
  }
</style>
</head>
<body>

<h1>üåä Ocean Buoy Dashboard</h1>

<div class="status-box">
  <div class="status">Current Status: <span id="buoy-status">OFFLINE</span></div>
  <div class="status">Last Event: <span id="event-type">None</span></div>
  <div class="status">Magnitude: <span id="magnitude">0</span></div>
  <div class="status">Latitude: <span id="lat">0</span></div>
  <div class="status">Longitude: <span id="lon">0</span></div>
  <div class="status">RSSI: <span id="rssi">0</span></div>
  <div class="status">GPS Valid: <span id="gps-valid">No</span></div>
  <div class="status">Event Count: <span id="event-count">0</span></div>
  <div class="status">Real Time: <span id="real-time">--:--:--</span></div>
  <div id="warning" class="event-warning"></div>
  <button onclick="clearEvent()">Clear Event</button>
</div>

<script>
const CHANNEL_ID = "3203006";
const READ_API_KEY = "JN2TR7S7XJLS9TWW"; // Leave empty if public

let lastEventId = 0;

// Format current local time
function updateTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString();
  document.getElementById('real-time').textContent = timeStr;
}
setInterval(updateTime, 1000);

// Clear event button
function clearEvent() {
  lastEventId = 0;
  document.getElementById('event-type').textContent = "None";
  document.getElementById('magnitude').textContent = "0";
  document.getElementById('lat').textContent = "0";
  document.getElementById('lon').textContent = "0";
  document.getElementById('rssi').textContent = "0";
  document.getElementById('gps-valid').textContent = "No";
  document.getElementById('event-count').textContent = "0";
  document.getElementById('warning').textContent = "";
}

// Fetch latest ThingSpeak data
async function fetchData() {
  try {
    const url = READ_API_KEY
      ? `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=1`
      : `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=1`;
    
    const res = await fetch(url);
    const data = await res.json();
    if (!data.feeds || data.feeds.length === 0) return;

    const feed = data.feeds[0];

    const eventType = feed.field1 || "STATUS";
    const magnitude = feed.field2 || "0";
    const lat = feed.field3 || "0";
    const lon = feed.field4 || "0";
    const rssi = feed.field5 || "0";
    const gpsValid = feed.field6 == "1" ? "Yes" : "No";
    const eventCount = feed.field7 || "0";
    const status = feed.field8 || "OFFLINE";

    // Only update if new event
    if (feed.entry_id != lastEventId) {
      lastEventId = feed.entry_id;

      document.getElementById('buoy-status').textContent = status;
      document.getElementById('event-type').textContent = eventType;
      document.getElementById('magnitude').textContent = magnitude;
      document.getElementById('lat').textContent = lat;
      document.getElementById('lon').textContent = lon;
      document.getElementById('rssi').textContent = rssi;
      document.getElementById('gps-valid').textContent = gpsValid;
      document.getElementById('event-count').textContent = eventCount;

      const warningEl = document.getElementById('warning');
      if (eventType === "IMPACT") {
        warningEl.textContent = "‚ö†Ô∏è IMPACT DETECTED!";
      } else if (eventType === "DRIFT") {
        warningEl.textContent = "üåä DRIFT ALERT!";
      } else {
        warningEl.textContent = "";
      }
    }
  } catch (err) {
    console.error("Error fetching ThingSpeak data:", err);
  }
}

// Refresh every 15 seconds
fetchData();
setInterval(fetchData, 15000);
</script>

</body>
</html>
