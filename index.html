<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buoy Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #666666;
            --text-muted: #333333;
            --accent: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #a855f7;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        h1 {
            font-size: 1.75rem;
            font-weight: 300;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }
        
        .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.813rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.813rem;
            color: var(--text-secondary);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .widget {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            transition: border-color 0.2s;
        }
        
        .widget:hover {
            border-color: var(--text-muted);
        }
        
        .widget-title {
            font-size: 0.688rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 300;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px;
            line-height: 1;
        }
        
        .stat-unit {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .data-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .data-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .data-label {
            font-size: 0.813rem;
            color: var(--text-secondary);
        }
        
        .data-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.688rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid;
        }
        
        .badge-success {
            color: var(--success);
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .badge-warning {
            color: var(--warning);
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .badge-danger {
            color: var(--danger);
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .badge-purple {
            color: var(--purple);
            border-color: var(--purple);
            background: rgba(168, 85, 247, 0.1);
        }
        
        .badge-neutral {
            color: var(--text-secondary);
            border-color: var(--border);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .chart-container {
            position: relative;
            height: 180px;
        }
        
        .alert-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            background: var(--surface);
            border: 1px solid;
            max-width: 320px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: none;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-banner.show {
            display: block;
        }
        
        .alert-banner.alert-impact {
            border-color: var(--danger);
        }
        
        .alert-banner.alert-drift {
            border-color: var(--warning);
        }
        
        .alert-banner-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .alert-banner-text {
            font-size: 0.813rem;
            color: var(--text-secondary);
        }
        
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-accent { color: var(--accent); }
        .text-purple { color: var(--purple); }
        
        .event-widget {
            background: var(--surface);
            border: 2px solid var(--border);
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .event-widget::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--text-muted);
            transition: background 0.3s;
        }
        
        .event-widget.event-impact::before {
            background: var(--danger);
        }
        
        .event-widget.event-drift::before {
            background: var(--warning);
        }
        
        .event-widget.event-status::before {
            background: var(--accent);
        }
        
        .event-widget.event-waiting::before {
            background: var(--text-muted);
        }
        
        .event-label {
            font-size: 0.688rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .buoy-status-big {
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 20px;
            padding: 8px 20px;
            display: inline-block;
            border: 1px solid;
        }
        
        .buoy-status-big.standby {
            color: var(--purple);
            border-color: var(--purple);
            background: rgba(168, 85, 247, 0.1);
        }
        
        .buoy-status-big.deploying {
            color: var(--warning);
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .buoy-status-big.deployed {
            color: var(--success);
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .buoy-status-big.override {
            color: var(--warning);
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.15);
        }
        
        .event-type-big {
            font-size: 4rem;
            font-weight: 300;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -2px;
            line-height: 1;
            margin-bottom: 12px;
            transition: color 0.3s;
        }
        
        .event-description {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .event-magnitude-display {
            display: inline-block;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 500;
            margin-top: 8px;
        }
        
        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.813rem;
        }
        
        .developer-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .instagram-link {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .instagram-link:hover {
            color: var(--text-primary);
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px 16px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .event-widget {
                padding: 30px 20px;
            }
            
            .event-type-big {
                font-size: 2.5rem;
            }
            
            .event-magnitude-display {
                font-size: 1.2rem;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Buoy Monitoring System</h1>
            <p class="subtitle">Real-time seismic buoy data stream</p>
            <div class="status-row">
                <div class="status-indicator">
                    <div class="dot"></div>
                    <span>LIVE</span>
                </div>
                <div class="time" id="currentTime">--:--:--</div>
            </div>
        </header>
        
        <div class="event-widget event-waiting" id="eventWidget">
            <div class="event-label">Current Event</div>
            <div class="buoy-status-big standby" id="buoyStatusBig">STANDBY</div>
            <div class="event-type-big" id="eventTypeBig">WAITING</div>
            <div class="event-description" id="eventDescriptionBig">No events detected</div>
            <div class="event-magnitude-display" id="magnitudeBig">0.000 m/s²</div>
        </div>
        
        <br>
        
        <div class="grid">
            <div class="widget">
                <div class="widget-title">Event Type</div>
                <div class="stat-value" id="eventType">--</div>
                <div class="stat-unit" id="eventSubtype">Waiting for data</div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Magnitude</div>
                <div class="stat-value" id="magnitude">--</div>
                <div class="stat-unit">g-force</div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Signal Strength</div>
                <div class="stat-value" id="rssi">--</div>
                <div class="stat-unit">dBm</div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Total Events</div>
                <div class="stat-value" id="eventCount">0</div>
                <div class="stat-unit">recorded</div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="widget">
                <div class="widget-title">Magnitude History</div>
                <div class="chart-container">
                    <canvas id="magnitudeChart"></canvas>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-title">System Status</div>
                <div class="data-list">
                    <div class="data-item">
                        <span class="data-label">Buoy Status</span>
                        <span class="data-value" id="buoyStatus">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">GPS Status</span>
                        <span class="data-value" id="gpsStatus">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Last Update</span>
                        <span class="data-value" id="lastUpdate">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="widget">
                <div class="widget-title">GPS Coordinates</div>
                <div class="data-list">
                    <div class="data-item">
                        <span class="data-label">Latitude</span>
                        <span class="data-value" id="latitude">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Longitude</span>
                        <span class="data-value" id="longitude">--</span>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Debug Info</div>
                <div class="data-list">
                    <div class="data-item">
                        <span class="data-label">Raw Data</span>
                        <span class="data-value" id="debugInfo">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Developed by <span class="developer-name">Muhammad Irfan</span></p>
            <p><a href="https://instagram.com/hzetronics" target="_blank" class="instagram-link">@hzetronics</a></p>
        </footer>
    </div>
    
    <div class="alert-banner" id="alertBanner">
        <div class="alert-banner-title" id="alertTitle"></div>
        <div class="alert-banner-text" id="alertText"></div>
    </div>

    <script>
        // Configuration
        const CHANNEL_ID = '3203006';
        const READ_API_KEY = 'JN2TR7S7XJLS9TWW';
        const REFRESH_INTERVAL = 15000; // 15 seconds to match ThingSpeak update rate
        const API_URL = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json?api_key=${READ_API_KEY}`;
        
        // Chart Setup
        const ctx = document.getElementById('magnitudeChart').getContext('2d');
        const magnitudeData = [];
        const maxDataPoints = 20;
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    borderWidth: 1.5,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 8,
                        displayColors: false,
                        callbacks: {
                            title: () => '',
                            label: (context) => `${context.parsed.y.toFixed(3)} g`
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: {
                        border: { display: false },
                        grid: {
                            color: '#1a1a1a',
                            drawTicks: false
                        },
                        ticks: {
                            color: '#666666',
                            font: { size: 10, family: 'JetBrains Mono' },
                            padding: 8,
                            callback: (value) => value.toFixed(2)
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        
        let previousData = {};
        
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        setInterval(updateClock, 1000);
        updateClock();
        
        function showAlert(title, text, type = 'impact') {
            const banner = document.getElementById('alertBanner');
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertText').textContent = text;
            
            banner.className = 'alert-banner show alert-' + type;
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
        }
        
        async function fetchData() {
            try {
                console.log('Fetching from:', API_URL);
                const response = await fetch(API_URL);
                const data = await response.json();
                
                console.log('Received data:', data);
                
                if (!data || !data.created_at) {
                    console.error('Invalid data received');
                    return;
                }
                
                // CORRECT FIELD MAPPING:
                // Field 1: Event Type (1=IMPACT, 2=DRIFT, 3=STATUS)
                // Field 2: Magnitude (m/s² or meters for drift)
                // Field 3: Latitude
                // Field 4: Longitude
                // Field 5: RSSI
                // Field 6: GPS Valid (1/0)
                // Field 7: Event Count
                // Field 8: Buoy Status (1=Not Deployed, 2=Deployed Normal, 3=Deployed Override)
                
                const eventTypeCode = parseInt(data.field1) || 3;
                const magnitude = parseFloat(data.field2) || 0;
                const latitude = parseFloat(data.field3) || 0;
                const longitude = parseFloat(data.field4) || 0;
                const rssi = parseInt(data.field5) || 0;
                const gpsValid = parseInt(data.field6) || 0;
                const eventCount = parseInt(data.field7) || 0;
                const buoyStatusCode = parseInt(data.field8) || 1;
                
                // Map buoy status (1=Standby, 2=Deploying, 3=Deployed, 4=Override)
                let buoyStatusText = 'STANDBY';
                let buoyStatusClass = 'standby';
                
                if (buoyStatusCode === 1) {
                    buoyStatusText = 'STANDBY';
                    buoyStatusClass = 'standby';
                } else if (buoyStatusCode === 2) {
                    buoyStatusText = 'DEPLOYING';
                    buoyStatusClass = 'deploying';
                } else if (buoyStatusCode === 3) {
                    buoyStatusText = 'DEPLOYED';
                    buoyStatusClass = 'deployed';
                } else if (buoyStatusCode === 4) {
                    buoyStatusText = 'OVERRIDE';
                    buoyStatusClass = 'override';
                }
                
                // Debug info - show raw values
                document.getElementById('debugInfo').textContent = 
                    `Type:${eventTypeCode} Mag:${magnitude} GPS:${gpsValid} Status:${buoyStatusCode} (${buoyStatusText})`;
                
                // Map event type to display
                let eventType = 'WAITING';
                let eventSubtype = 'No events';
                let eventColor = 'text-accent';
                
                switch(eventTypeCode) {
                    case 1:
                        eventType = 'IMPACT';
                        eventSubtype = 'High acceleration detected';
                        eventColor = 'text-danger';
                        break;
                    case 2:
                        eventType = 'DRIFT';
                        eventSubtype = 'Position or orientation change';
                        eventColor = 'text-warning';
                        break;
                    case 3:
                        eventType = 'STATUS';
                        eventSubtype = 'System status update';
                        eventColor = 'text-accent';
                        break;
                }
                
                // Check for new events and show alerts
                if (previousData.eventCount !== undefined && eventCount > previousData.eventCount) {
                    if (eventTypeCode === 1) {
                        showAlert('⚠️ IMPACT DETECTED', `Magnitude: ${magnitude.toFixed(2)} m/s²`, 'impact');
                    } else if (eventTypeCode === 2) {
                        showAlert('⚠️ DRIFT DETECTED', `Distance/Change: ${magnitude.toFixed(2)} m`, 'drift');
                    }
                }
                
                // Update main event type display
                const eventTypeEl = document.getElementById('eventType');
                eventTypeEl.textContent = eventType;
                eventTypeEl.className = `stat-value ${eventColor}`;
                document.getElementById('eventSubtype').textContent = eventSubtype;
                
                // Update BIG Event Widget
                const eventWidget = document.getElementById('eventWidget');
                const eventTypeBig = document.getElementById('eventTypeBig');
                const eventDescriptionBig = document.getElementById('eventDescriptionBig');
                const magnitudeBig = document.getElementById('magnitudeBig');
                const buoyStatusBig = document.getElementById('buoyStatusBig');
                
                // Update buoy status badge
                buoyStatusBig.textContent = buoyStatusText;
                buoyStatusBig.className = `buoy-status-big ${buoyStatusClass}`;
                
                eventWidget.classList.remove('event-impact', 'event-drift', 'event-status', 'event-waiting');
                
                if (eventTypeCode === 1) {
                    eventWidget.classList.add('event-impact');
                    eventTypeBig.className = 'event-type-big text-danger';
                    magnitudeBig.textContent = magnitude.toFixed(2) + ' m/s²';
                } else if (eventTypeCode === 2) {
                    eventWidget.classList.add('event-drift');
                    eventTypeBig.className = 'event-type-big text-warning';
                    magnitudeBig.textContent = magnitude.toFixed(2) + ' m';
                } else if (eventTypeCode === 3) {
                    eventWidget.classList.add('event-status');
                    eventTypeBig.className = 'event-type-big text-accent';
                    magnitudeBig.textContent = magnitude.toFixed(3) + ' m/s²';
                } else {
                    eventWidget.classList.add('event-waiting');
                    eventTypeBig.className = 'event-type-big';
                    magnitudeBig.textContent = '0.000';
                }
                
                eventTypeBig.textContent = eventType;
                eventDescriptionBig.textContent = eventSubtype;
                
                // Update stat cards
                document.getElementById('magnitude').textContent = magnitude.toFixed(3);
                document.getElementById('rssi').textContent = rssi;
                document.getElementById('eventCount').textContent = eventCount;
                
                // Update buoy deployment status in side panel
                const buoyStatusEl = document.getElementById('buoyStatus');
                if (buoyStatusCode === 1) {
                    buoyStatusEl.innerHTML = '<span class="badge badge-purple">STANDBY</span>';
                } else if (buoyStatusCode === 2) {
                    buoyStatusEl.innerHTML = '<span class="badge badge-warning">DEPLOYING</span>';
                } else if (buoyStatusCode === 3) {
                    buoyStatusEl.innerHTML = '<span class="badge badge-success">DEPLOYED</span>';
                } else if (buoyStatusCode === 4) {
                    buoyStatusEl.innerHTML = '<span class="badge badge-warning">OVERRIDE</span>';
                } else {
                    buoyStatusEl.innerHTML = '<span class="badge badge-neutral">UNKNOWN</span>';
                }
                
                // Update GPS status
                const gpsEl = document.getElementById('gpsStatus');
                if (gpsValid === 1) {
                    gpsEl.innerHTML = '<span class="badge badge-success">LOCKED</span>';
                } else {
                    gpsEl.innerHTML = '<span class="badge badge-danger">NO LOCK</span>';
                }
                
                // Update GPS coordinates
                if (latitude !== 0 && longitude !== 0 && gpsValid === 1) {
                    document.getElementById('latitude').textContent = latitude.toFixed(6) + '°';
                    document.getElementById('longitude').textContent = longitude.toFixed(6) + '°';
                } else {
                    document.getElementById('latitude').textContent = 'NO DATA';
                    document.getElementById('longitude').textContent = 'NO DATA';
                }
                
                // Update last update time
                const updateTime = new Date(data.created_at);
                document.getElementById('lastUpdate').textContent = updateTime.toLocaleTimeString('en-US', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Update chart with magnitude history
                if (magnitude > 0 || eventTypeCode !== 3) {
                    magnitudeData.push(magnitude);
                    if (magnitudeData.length > maxDataPoints) {
                        magnitudeData.shift();
                    }
                    
                    chart.data.labels = magnitudeData.map((_, i) => i + 1);
                    chart.data.datasets[0].data = magnitudeData;
                    chart.update('none');
                }
                
                // Store previous data for change detection
                previousData = { eventCount, eventTypeCode };
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('debugInfo').textContent = 'ERROR: ' + error.message;
            }
        }
        
        // Initial fetch and set interval
        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL);
    </script>
</body>
</html>
