<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buoy Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #666666;
            --text-muted: #333333;
            --accent: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #a855f7;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Header */
        header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        h1 {
            font-size: 1.75rem;
            font-weight: 300;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }
        
        .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.813rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.813rem;
            color: var(--text-secondary);
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        /* Widget Base */
        .widget {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            transition: border-color 0.2s;
        }
        
        .widget:hover {
            border-color: var(--text-muted);
        }
        
        .widget-title {
            font-size: 0.688rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        /* Stat Widget */
        .stat-value {
            font-size: 2.5rem;
            font-weight: 300;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px;
            line-height: 1;
        }
        
        .stat-unit {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* Data List Widget */
        .data-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .data-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .data-label {
            font-size: 0.813rem;
            color: var(--text-secondary);
        }
        
        .data-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.688rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid;
        }
        
        .badge-success {
            color: var(--success);
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .badge-warning {
            color: var(--warning);
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .badge-danger {
            color: var(--danger);
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .badge-purple {
            color: var(--purple);
            border-color: var(--purple);
            background: rgba(168, 85, 247, 0.1);
        }
        
        .badge-neutral {
            color: var(--text-secondary);
            border-color: var(--border);
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Chart Widget */
        .chart-container {
            position: relative;
            height: 180px;
        }
        
        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            background: var(--surface);
            border: 1px solid;
            max-width: 320px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: none;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-banner.show {
            display: block;
        }
        
        .alert-banner.alert-impact {
            border-color: var(--danger);
        }
        
        .alert-banner.alert-drift {
            border-color: var(--warning);
        }
        
        .alert-banner-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .alert-banner-text {
            font-size: 0.813rem;
            color: var(--text-secondary);
        }
        
        /* Color Highlights */
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-accent { color: var(--accent); }
        .text-purple { color: var(--purple); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px 16px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Buoy Monitoring System</h1>
            <p class="subtitle">Real-time seismic buoy data stream</p>
            <div class="status-row">
                <div class="status-indicator">
                    <div class="dot"></div>
                    <span>LIVE</span>
                </div>
                <div class="time" id="currentTime">--:--:--</div>
            </div>
        </header>
        
        <!-- Primary Stats -->
        <div class="grid">
            <div class="widget">
                <div class="widget-title">Event Type</div>
                <div class="stat-value" id="eventType">--</div>
                <div class="stat-unit" id="eventSubtype">Waiting for data</div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Magnitude</div>
                <div class="stat-value" id="magnitude">--</div>
                <div class="stat-unit">g-force</div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Signal Strength</div>
                <div class="stat-value" id="rssi">--</div>
                <div class="stat-unit">dBm</div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Total Events</div>
                <div class="stat-value" id="eventCount">0</div>
                <div class="stat-unit">recorded</div>
            </div>
        </div>
        
        <!-- Chart and Status -->
        <div class="grid-2">
            <div class="widget">
                <div class="widget-title">Magnitude History</div>
                <div class="chart-container">
                    <canvas id="magnitudeChart"></canvas>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-title">System Status</div>
                <div class="data-list">
                    <div class="data-item">
                        <span class="data-label">Deployment</span>
                        <span class="data-value" id="deployStatus">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Operation Mode</span>
                        <span class="data-value" id="modeStatus">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">GPS Status</span>
                        <span class="data-value" id="gpsStatus">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Total Packets</span>
                        <span class="data-value" id="totalPackets">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Location Data -->
        <div class="grid">
            <div class="widget">
                <div class="widget-title">GPS Coordinates</div>
                <div class="data-list">
                    <div class="data-item">
                        <span class="data-label">Latitude</span>
                        <span class="data-value" id="latitude">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Longitude</span>
                        <span class="data-value" id="longitude">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">GPS Valid</span>
                        <span class="data-value" id="gpsValid">--</span>
                    </div>
                </div>
            </div>
            
            <div class="widget">
                <div class="widget-title">Connection Info</div>
                <div class="data-list">
                    <div class="data-item">
                        <span class="data-label">Last Update</span>
                        <span class="data-value" id="lastUpdate">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Buoy Status</span>
                        <span class="data-value" id="buoyStatus">Initializing</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <div class="alert-banner-title" id="alertTitle"></div>
        <div class="alert-banner-text" id="alertText"></div>
    </div>

    <script>
        // Configuration
        const CHANNEL_ID = '3203006';
        const REFRESH_INTERVAL = 8000; // 8 seconds
        const API_URL = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json`;
        
        // Chart Setup
        const ctx = document.getElementById('magnitudeChart').getContext('2d');
        const magnitudeData = [];
        const maxDataPoints = 20;
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    borderWidth: 1.5,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 8,
                        displayColors: false,
                        callbacks: {
                            title: () => '',
                            label: (context) => `${context.parsed.y.toFixed(3)} g`
                        }
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        border: { display: false },
                        grid: {
                            color: '#1a1a1a',
                            drawTicks: false
                        },
                        ticks: {
                            color: '#666666',
                            font: { size: 10, family: 'JetBrains Mono' },
                            padding: 8,
                            callback: (value) => value.toFixed(2)
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        
        // State tracking
        let previousData = {};
        
        // Update clock
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        setInterval(updateClock, 1000);
        updateClock();
        
        // Show alert banner
        function showAlert(title, text, type = 'impact') {
            const banner = document.getElementById('alertBanner');
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertText').textContent = text;
            
            banner.className = 'alert-banner show alert-' + type;
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
        }
        
        // Fetch and update data
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (!data || !data.created_at) {
                    console.error('Invalid data received');
                    return;
                }
                
                // Parse ThingSpeak fields
                // Based on Arduino code:
                // field1: eventType (1=IMPACT, 2=DRIFT, 3=STATUS, 4=OFFLINE)
                // field2: magnitude
                // field3: rssi
                // field4: eventCount
                // field5: gpsValid (1=valid, 0=invalid)
                // field6: latitude
                // field7: longitude
                // field8: totalPackets
                // field9: (reserved)
                // field10: deployed (1=deployed, 0=not deployed)
                // field11: override (1=override mode, 0=normal)
                
                const eventTypeCode = parseInt(data.field1) || 0;
                const magnitude = parseFloat(data.field2) || 0;
                const rssi = parseInt(data.field3) || 0;
                const eventCount = parseInt(data.field4) || 0;
                const gpsValid = parseInt(data.field5) || 0;
                const latitude = parseFloat(data.field6) || 0;
                const longitude = parseFloat(data.field7) || 0;
                const totalPackets = parseInt(data.field8) || 0;
                const deployed = parseInt(data.field10) || 0;
                const override = parseInt(data.field11) || 0;
                
                // Map event type code to string
                let eventType = 'UNKNOWN';
                let eventSubtype = 'Unknown event';
                let eventColor = 'text-accent';
                
                switch(eventTypeCode) {
                    case 1:
                        eventType = 'IMPACT';
                        eventSubtype = 'High energy detection';
                        eventColor = 'text-danger';
                        break;
                    case 2:
                        eventType = 'DRIFT';
                        eventSubtype = 'Position drift detected';
                        eventColor = 'text-warning';
                        break;
                    case 3:
                        eventType = 'STATUS';
                        eventSubtype = 'Status update';
                        eventColor = 'text-accent';
                        break;
                    case 4:
                        eventType = 'OFFLINE';
                        eventSubtype = 'No signal received';
                        eventColor = 'text-danger';
                        break;
                    default:
                        eventType = 'WAITING';
                        eventSubtype = 'No events';
                }
                
                // Check for new impact or drift events
                if (previousData.eventCount !== undefined && eventCount > previousData.eventCount) {
                    if (eventTypeCode === 1) {
                        showAlert('⚠️ IMPACT DETECTED', `Magnitude: ${magnitude.toFixed(3)}g`, 'impact');
                    } else if (eventTypeCode === 2) {
                        showAlert('⚠️ DRIFT DETECTED', 'Position change detected', 'drift');
                    }
                }
                
                // Update UI
                const eventTypeEl = document.getElementById('eventType');
                eventTypeEl.textContent = eventType;
                eventTypeEl.className = `stat-value ${eventColor}`;
                document.getElementById('eventSubtype').textContent = eventSubtype;
                
                document.getElementById('magnitude').textContent = magnitude.toFixed(3);
                document.getElementById('rssi').textContent = rssi;
                document.getElementById('eventCount').textContent = eventCount;
                document.getElementById('totalPackets').textContent = totalPackets;
                
                // Update deployment status
                const deployEl = document.getElementById('deployStatus');
                if (deployed === 1) {
                    deployEl.innerHTML = '<span class="badge badge-success">DEPLOYED</span>';
                } else {
                    deployEl.innerHTML = '<span class="badge badge-purple">FREE MODE</span>';
                }
                
                // Update operation mode
                const modeEl = document.getElementById('modeStatus');
                if (override === 1) {
                    modeEl.innerHTML = '<span class="badge badge-warning">OVERRIDE</span>';
                } else {
                    modeEl.innerHTML = '<span class="badge badge-success">NORMAL</span>';
                }
                
                // Update GPS status
                const gpsEl = document.getElementById('gpsStatus');
                if (gpsValid === 1) {
                    gpsEl.innerHTML = '<span class="badge badge-success">LOCKED</span>';
                } else {
                    gpsEl.innerHTML = '<span class="badge badge-danger">NO LOCK</span>';
                }
                
                // Update GPS coordinates
                if (latitude !== 0 && longitude !== 0) {
                    document.getElementById('latitude').textContent = latitude.toFixed(6) + '°';
                    document.getElementById('longitude').textContent = longitude.toFixed(6) + '°';
                } else {
                    document.getElementById('latitude').textContent = 'NO DATA';
                    document.getElementById('longitude').textContent = 'NO DATA';
                }
                
                document.getElementById('gpsValid').textContent = gpsValid === 1 ? 'VALID' : 'INVALID';
                
                // Update buoy status based on state
                let buoyStatusText = 'Active';
                if (deployed === 0) {
                    buoyStatusText = 'Not Deployed';
                } else if (override === 1) {
                    buoyStatusText = 'Override Mode';
                } else if (eventTypeCode === 1) {
                    buoyStatusText = 'Impact Detected';
                } else if (eventTypeCode === 2) {
                    buoyStatusText = 'Drift Detected';
                } else {
                    buoyStatusText = 'Monitoring';
                }
                document.getElementById('buoyStatus').textContent = buoyStatusText;
                
                // Update last update time
                const updateTime = new Date(data.created_at);
                document.getElementById('lastUpdate').textContent = updateTime.toLocaleTimeString('en-US', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Update chart
                if (magnitude > 0) {
                    magnitudeData.push(magnitude);
                    if (magnitudeData.length > maxDataPoints) {
                        magnitudeData.shift();
                    }
                    
                    chart.data.labels = magnitudeData.map((_, i) => i + 1);
                    chart.data.datasets[0].data = magnitudeData;
                    chart.update('none');
                }
                
                // Store previous data for change detection
                previousData = { eventCount, eventTypeCode };
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        // Initial fetch and set interval
        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL);
    </script>
</body>
</html>
